<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nono Booking Platform</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .modal-backdrop { background: rgba(0,0,0,0.45); }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">

<div id="app" class="min-h-screen flex items-center justify-center p-6"
     style="background-image: linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.6)), url('https://images.unsplash.com/photo-1504384308090-c894fdcc538d?auto=format&fit=crop&w=1600&q=80'); background-size:cover;">
  <div id="homeCard" class="bg-white/90 backdrop-blur-md rounded-2xl shadow-2xl p-8 text-center max-w-xl w-full">
    <div class="flex flex-col gap-4">
      <button onclick="startTrialFlow()" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 rounded-xl shadow-lg transition">7-Day Trial</button>
      <button onclick="renderPaidSignup()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 rounded-xl shadow-lg transition">Subscribe $11/month</button>
      <button onclick="renderLogin()" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-3 rounded-xl shadow-lg transition">Login</button>
    </div>
  </div>
</div>

<div id="modalContainer"></div>

<script>
function uid(prefix='id'){ return prefix + '_' + Math.random().toString(36).slice(2,10); }
function qs(sel){ return document.querySelector(sel); }
function qsa(sel){ return Array.from(document.querySelectorAll(sel)); }
function slugify(s){ return String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }

// ---------- localStorage helpers ----------
function getUser(){ return JSON.parse(localStorage.getItem('nono_user') || 'null'); }
function setUser(u){ localStorage.setItem('nono_user', JSON.stringify(u)); }
function getServices(slug){ return JSON.parse(localStorage.getItem('nono_services_' + slug) || '[]'); }
function setServices(slug, arr){ localStorage.setItem('nono_services_' + slug, JSON.stringify(arr)); }
function getBookings(slug){ return JSON.parse(localStorage.getItem('nono_bookings_' + slug) || '[]'); }
function setBookings(slug, arr){ localStorage.setItem('nono_bookings_' + slug, JSON.stringify(arr)); }

// ---------- Trial Flow ----------
function startTrialFlow(){
  const name = prompt('Enter your business name for 7-day trial:');
  if(!name) return;
  const email = prompt('Enter email:');
  if(!email) return;
  const password = prompt('Enter password:');
  if(!password) return;

  const slug = slugify(name);
  const now = Date.now();
  const expiry = now + 7*24*60*60*1000; // 7 days trial in ms
  const user = { business:name, email, password, slug, type:'trial', trial_expiry:expiry, subscribed:false };
  setUser(user);
  setServices(slug, []);
  setBookings(slug, []);
  renderDashboard(user);
}

// ---------- Paid Signup ----------
function renderPaidSignup(){
  const name = prompt('Business name:');
  if(!name) return;
  const email = prompt('Email:');
  if(!email) return;
  const password = prompt('Password:');
  if(!password) return;

  const slug = slugify(name);
  const now = Date.now();
  const user = { business:name, email, password, slug, type:'paid', subscribed:true, subscription_start:now };
  setUser(user);
  setServices(slug, []);
  setBookings(slug, []);
  renderDashboard(user);
}

// ---------- Login ----------
function renderLogin(){
  const email = prompt('Email:');
  if(!email) return;
  const password = prompt('Password:');
  if(!password) return;

  const user = getUser();
  if(!user) return alert('No account found');

  if(user.email===email && user.password===password){
    const now = Date.now();
    if(user.type==='trial' && now>user.trial_expiry){
      return alert('Trial expired. Please subscribe.');
    }
    if(user.type==='paid'){
      const monthMs = 30*24*60*60*1000;
      if(now - user.subscription_start > monthMs){
        return alert('Subscription expired. Please renew.');
      }
    }
    renderDashboard(user);
  } else alert('Invalid credentials');
}

// ---------- Dashboard ----------
function renderDashboard(user){
  const slug = user.slug;
  document.body.innerHTML = `
  <div class="min-h-screen p-6 bg-gray-100">
    <header class="flex justify-between items-center mb-6">
      <div>
        <h1 class="text-2xl font-bold">${user.business}</h1>
        <div class="text-sm text-gray-600">Email: ${user.email}</div>
        <div class="text-sm text-gray-600">Your link: <input type="text" value="?business=${slug}" readonly class="border px-2 rounded w-48"/></div>
      </div>
      <button onclick="logout()" class="bg-red-600 text-white px-4 py-2 rounded">Logout</button>
    </header>

    <div class="grid md:grid-cols-2 gap-6 mb-6">
      <div>
        <h2 class="text-xl font-semibold mb-2">Services</h2>
        <div class="flex gap-2 mb-2">
          <input id="newServiceName" placeholder="Service" class="border p-2 flex-1 rounded"/>
          <input id="newServicePrice" placeholder="Price" type="number" class="border p-2 w-24 rounded"/>
          <button onclick="addService('${slug}')" class="bg-green-600 text-white px-3 py-2 rounded">Add</button>
        </div>
        <div id="servicesContainer"></div>
      </div>
      <div>
        <h2 class="text-xl font-semibold mb-2">Bookings</h2>
        <table class="min-w-full text-left border">
          <thead class="bg-gray-200">
            <tr><th class="px-2 py-1">Name</th><th>Email</th><th>Phone</th><th>Service</th><th>Date</th></tr>
          </thead>
          <tbody id="bookingsTable"></tbody>
        </table>
      </div>
    </div>
  </div>
  `;
  populateServices(slug);
  populateBookings(slug);
}

function addService(slug){
  const name = qs('#newServiceName').value.trim();
  const price = Number(qs('#newServicePrice').value);
  if(!name) return alert('Enter name');
  const arr = getServices(slug);
  arr.push({ id: uid('svc'), name, price });
  setServices(slug, arr);
  qs('#newServiceName').value='';
  qs('#newServicePrice').value='';
  populateServices(slug);
}

function populateServices(slug){
  const cont = qs('#servicesContainer');
  const services = getServices(slug);
  cont.innerHTML = services.map(s=>`<div>${s.name} - $${s.price}</div>`).join('') || '<div>No services yet</div>';
}

function populateBookings(slug){
  const tbody = qs('#bookingsTable');
  const bookings = getBookings(slug);
  tbody.innerHTML = bookings.map(b=>`<tr><td>${b.name}</td><td>${b.email}</td><td>${b.phone}</td><td>${b.service}</td><td>${b.date}</td></tr>`).join('') || '<tr><td colspan="5">No bookings yet</td></tr>';
}

function logout(){ location.reload(); }

// ---------- Public booking ----------
(function initPublicBooking(){
  const params = new URLSearchParams(window.location.search);
  const biz = params.get('business');
  if(!biz) return;
  const services = getServices(biz);
  document.body.innerHTML = `
  <div class="min-h-screen flex items-center justify-center p-6 bg-gray-100">
    <div class="max-w-md w-full bg-white p-6 rounded-xl shadow">
      <h1 class="text-xl font-bold mb-4">Book for ${biz.replace(/-/g,' ')}</h1>
      <div id="servicesBooking">
        ${services.map(s=>`
          <div class="border p-2 rounded mb-2">
            <div>${s.name} - $${s.price}</div>
            <button onclick="bookService('${biz}','${s.id}')" class="bg-green-600 text-white px-2 py-1 rounded mt-1">Book Now</button>
          </div>`).join('') || '<div>No services available</div>'}
      </div>
    </div>
  </div>
  <div id="modalContainer"></div>
  `;
})();

function bookService(biz, id){
  const services = getServices(biz);
  const svc = services.find(s=>s.id===id);
  const modal = qs('#modalContainer');
  modal.innerHTML = `
    <div class="fixed inset-0 flex items-center justify-center modal-backdrop z-50">
      <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-md">
        <h3 class="text-lg font-semibold mb-2">Book: ${svc.name}</h3>
        <input id="book_name" placeholder="Name" class="w-full border p-2 mb-2 rounded"/>
        <input id="book_email" placeholder="Email" class="w-full border p-2 mb-2 rounded"/>
        <input id="book_phone" placeholder="Phone" class="w-full border p-2 mb-2 rounded"/>
        <input id="book_date" type="date" class="w-full border p-2 mb-2 rounded"/>
        <div class="flex gap-2">
          <button onclick="confirmBooking('${biz}','${svc.name}')" class="flex-1 bg-green-600 text-white py-2 rounded">Confirm</button>
          <button onclick="closeModal()" class="flex-1 border py-2 rounded">Cancel</button>
        </div>
      </div>
    </div>
  `;
}

function confirmBooking(biz, service){
  const name = qs('#book_name').value.trim();
  const email = qs('#book_email').value.trim();
  const phone = qs('#book_phone').value.trim();
  const date = qs('#book_date').value;
  if(!name||!email||!phone||!date) return alert('Fill all fields');
  const arr = getBookings(biz);
  arr.push({ id: uid('b'), name, email, phone, service, date });
  setBookings(biz, arr);
  alert('Booking confirmed!');
  closeModal();
}

function closeModal(){ qs('#modalContainer').innerHTML=''; }

</script>
</body>
</html>
