<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Rujex - Salon Manager (Supabase)</title>
<script src="https://cdn.tailwindcss.com"></script>
<!-- Supabase JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
<style>
  :root{
    --bg:#071021; --card:#0f1724; --muted:#9aa4b2; --accent:#7c3aed;
  }
  body{background:linear-gradient(180deg,var(--bg),#020617); color:#e6eef6;}
  .card{background:linear-gradient(180deg,var(--card),#071021);}
</style>
</head>
<body class="min-h-screen font-sans">

<div class="max-w-6xl mx-auto p-6">
  <header class="flex items-center justify-between mb-6">
    <div class="flex items-center gap-4">
      <div class="w-12 h-12 rounded-lg" style="background:linear-gradient(135deg,var(--accent),#06b6d4)"></div>
      <div>
        <h1 class="text-2xl font-bold">Rujex</h1>
        <p class="text-sm text-[--muted]">Appointments, reminders & simple subscriptions</p>
      </div>
    </div>
    <div class="flex items-center gap-3">
      <button id="btnShowLogin" class="px-4 py-2 rounded bg-[--accent]">Login / Sign up</button>
      <a id="homeLink" class="px-3 py-2 rounded border border-white/10 cursor-pointer">Home</a>
    </div>
  </header>

  <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- LEFT: Auth / Dashboard -->
    <section class="lg:col-span-2 space-y-6">

      <!-- AUTH CARD -->
      <div id="authCard" class="card p-6 rounded-2xl shadow">
        <h2 id="authTitle" class="text-xl font-semibold mb-3">Sign in</h2>
        <form id="authForm" class="space-y-3">
          <input id="email" type="email" placeholder="Email" class="w-full p-3 rounded bg-transparent border border-white/10" required />
          <input id="password" type="password" placeholder="Password" class="w-full p-3 rounded bg-transparent border border-white/10" required />
          <input id="businessName" type="text" placeholder="Business name (for signup)" class="w-full p-3 rounded bg-transparent border border-white/10 hidden" />
          <input id="businessSlug" type="text" placeholder="Business slug (e.g. mybarber)" class="w-full p-3 rounded bg-transparent border border-white/10 hidden" />
          <div class="flex items-center gap-3">
            <button id="authBtn" class="px-4 py-2 rounded bg-[--accent]">Sign in</button>
            <button id="toggleSign" type="button" class="px-3 py-2 rounded border border-white/10">Create account</button>
            <button id="demoBtn" type="button" class="ml-auto px-3 py-2 rounded bg-white/5">Demo fill</button>
          </div>
          <p id="authMsg" class="text-sm text-[--muted] mt-2"></p>
        </form>
      </div>

      <!-- DASHBOARD -->
      <div id="dashboardCard" class="card p-6 rounded-2xl shadow hidden">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h2 id="bizTitle" class="text-xl font-semibold">Business</h2>
            <p id="bizSub" class="text-sm text-[--muted]">Manage appointments & revenue</p>
          </div>
          <div class="flex items-center gap-2">
            <a id="publicLink" target="_blank" class="px-3 py-2 rounded bg-white/5">Public booking</a>
            <button id="logoutBtn" class="px-3 py-2 rounded border border-white/10">Logout</button>
          </div>
        </div>

        <!-- stats -->
        <div class="grid grid-cols-3 gap-4 mb-4">
          <div class="p-4 rounded bg-white/3 text-center">
            <div class="text-sm text-[--muted]">Clients</div>
            <div id="statClients" class="text-xl font-bold">0</div>
          </div>
          <div class="p-4 rounded bg-white/3 text-center">
            <div class="text-sm text-[--muted]">Upcoming</div>
            <div id="statUpcoming" class="text-xl font-bold">0</div>
          </div>
          <div class="p-4 rounded bg-white/3 text-center">
            <div class="text-sm text-[--muted]">Revenue</div>
            <div id="statRevenue" class="text-xl font-bold">$0</div>
          </div>
        </div>

        <!-- subscribe -->
        <div class="mb-4">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="font-semibold">Subscription</h3>
              <p class="text-sm text-[--muted]">Simulated $5/month subscription (click to simulate payment)</p>
            </div>
            <div>
              <span id="subStatus" class="text-sm text-[--muted]">Not subscribed</span>
              <button id="subBtn" class="ml-3 px-3 py-2 rounded bg-[--accent]">Pay $5 (simulate)</button>
            </div>
          </div>
        </div>

        <!-- add appointment -->
        <div class="mb-4">
          <h3 class="font-semibold mb-2">Add appointment</h3>
          <form id="addApptForm" class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <input id="apClient" placeholder="Client name" class="p-3 rounded bg-transparent border border-white/10" required />
            <input id="apEmail" placeholder="Client email (optional)" class="p-3 rounded bg-transparent border border-white/10" />
            <input id="apService" placeholder="Service" class="p-3 rounded bg-transparent border border-white/10" required />
            <input id="apDatetime" type="datetime-local" class="p-3 rounded bg-transparent border border-white/10 md:col-span-2" required />
            <input id="apPrice" type="number" placeholder="Price (USD)" class="p-3 rounded bg-transparent border border-white/10" />
            <button class="px-4 py-2 rounded bg-[--accent] md:col-span-1" type="submit">Save</button>
          </form>
        </div>

        <!-- appointments table -->
        <div>
          <h3 class="font-semibold mb-2">Appointments</h3>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="text-[--muted] text-left">
                <tr><th class="pb-2">Client</th><th class="pb-2">Service</th><th class="pb-2">When</th><th class="pb-2">Price</th><th class="pb-2">Status</th><th class="pb-2">Actions</th></tr>
              </thead>
              <tbody id="apptsTbody" class="align-top"></tbody>
            </table>
          </div>
        </div>
      </div>

    </section>

    <!-- RIGHT: Public booking preview -->
    <aside class="space-y-6">
      <div class="card p-6 rounded-2xl shadow">
        <h3 class="text-xl font-semibold mb-3">Public booking</h3>
        <p class="text-sm text-[--muted] mb-3">Open the public link: <span id="examplePublic" class="font-mono text-xs"></span></p>
        <div id="publicFormWrap" class="hidden">
          <form id="publicForm" class="space-y-3">
            <input id="pubName" placeholder="Your name" class="w-full p-3 rounded bg-transparent border border-white/10" required />
            <input id="pubEmail" type="email" placeholder="Your email" class="w-full p-3 rounded bg-transparent border border-white/10" required />
            <input id="pubService" placeholder="Service" class="w-full p-3 rounded bg-transparent border border-white/10" required />
            <input id="pubDatetime" type="datetime-local" class="w-full p-3 rounded bg-transparent border border-white/10" required />
            <button class="w-full px-4 py-2 rounded bg-[--accent]">Request appointment</button>
          </form>
          <p id="publicMsg" class="mt-2 text-sm text-[--muted]"></p>
        </div>
        <div id="noPublic" class="text-sm text-[--muted]">No public business selected â€” use <code>?biz=your-slug</code></div>
      </div>

      <div class="card p-6 rounded-2xl shadow text-sm text-[--muted]">
        <strong>How to launch</strong>
        <ol class="list-decimal ml-5 mt-2">
          <li>Set SUPABASE_URL &amp; SUPABASE_ANON_KEY in the script below.</li>
          <li>Run the SQL in Supabase SQL Editor (tables + policies).</li>
          <li>Deploy this file to Vercel/Netlify or open locally (Auth may require proper origin).</li>
        </ol>
      </div>
    </aside>

  </main>
</div>

<script>
/* ======================
  PUT YOUR SUPABASE CREDENTIALS HERE
  Replace the strings below with values from Supabase > Settings > API
  SUPABASE_URL example: https://abcd1234.supabase.co
  SUPABASE_ANON_KEY is the "anon public" key
====================== */
const SUPABASE_URL = "https://dulosxwinpzkuiidgalf.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR1bG9zeHdpbnB6a3VpaWRnYWxmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyMjAyMTEsImV4cCI6MjA3NTc5NjIxMX0.KiVvgqUUcgC65hD3hG3bfxkIUk4gyz6KA8MtJuvqXUs";

/* ===== Init supabase client ===== */
const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ===== UI refs ===== */
const authCard = document.getElementById('authCard');
const authForm = document.getElementById('authForm');
const authTitle = document.getElementById('authTitle');
const emailInput = document.getElementById('email');
const passwordInput = document.getElementById('password');
const businessName = document.getElementById('businessName');
const businessSlug = document.getElementById('businessSlug');
const toggleSign = document.getElementById('toggleSign');
const authBtn = document.getElementById('authBtn');
const authMsg = document.getElementById('authMsg');
const demoBtn = document.getElementById('demoBtn');

const dashboardCard = document.getElementById('dashboardCard');
const bizTitle = document.getElementById('bizTitle');
const bizSub = document.getElementById('bizSub');
const publicLink = document.getElementById('publicLink');

const statClients = document.getElementById('statClients');
const statUpcoming = document.getElementById('statUpcoming');
const statRevenue = document.getElementById('statRevenue');

const subStatus = document.getElementById('subStatus');
const subBtn = document.getElementById('subBtn');

const addApptForm = document.getElementById('addApptForm');
const apClient = document.getElementById('apClient');
const apEmail = document.getElementById('apEmail');
const apService = document.getElementById('apService');
const apDatetime = document.getElementById('apDatetime');
const apPrice = document.getElementById('apPrice');
const apptsTbody = document.getElementById('apptsTbody');

const publicFormWrap = document.getElementById('publicFormWrap');
const publicForm = document.getElementById('publicForm');
const publicMsg = document.getElementById('publicMsg');
const noPublic = document.getElementById('noPublic');
const examplePublic = document.getElementById('examplePublic');

let createMode = false;
let currentSalon = null; // object from salons table

/* Toggle create / login */
toggleSign.addEventListener('click', ()=> setCreateMode(!createMode));
document.getElementById('btnShowLogin').addEventListener('click', ()=> { setCreateMode(false); window.scrollTo({top:0, behavior:'smooth'}) });

demoBtn.addEventListener('click', ()=> {
  emailInput.value = 'owner@rujex.test';
  passwordInput.value = 'password';
  businessName.value = 'My Barber Shop';
  businessSlug.value = 'mybarber';
});

function setCreateMode(on){
  createMode = !!on;
  businessName.classList.toggle('hidden', !on);
  businessSlug.classList.toggle('hidden', !on);
  authTitle.textContent = on ? 'Create business account' : 'Sign in';
  authBtn.textContent = on ? 'Create account' : 'Sign in';
  authMsg.textContent = '';
}

/* ===== AUTH (sign up / sign in using Supabase Auth and profile table) ===== */
authForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const email = emailInput.value.trim().toLowerCase();
  const password = passwordInput.value;
  const name = businessName.value.trim();
  const slug = businessSlug.value.trim().toLowerCase();

  if(createMode){
    if(!email || !password || !name || !slug){ authMsg.textContent = 'Please fill all fields'; return; }
    // create supabase auth user then create salon profile row
    const { data: signData, error: signErr } = await supabase.auth.signUp({ email, password });
    if(signErr){ authMsg.textContent = 'Sign up error: '+signErr.message; return; }
    // wait a bit for user creation (or handle via onAuthStateChange)
    // create profile in 'salons' table with owner = auth.uid()
    // get user session to obtain uid
    const { data: session } = await supabase.auth.getSession();
    const uid = session?.data?.session?.user?.id;
    if(!uid){
      authMsg.textContent = 'Sign up created. Please confirm email then login.';
      // still create row with null owner? safer to create after user confirm - but for MVP create without owner
      await supabase.from('salons').insert([{ email, name, slug }]);
      return;
    }
    // insert salon row with owner = uid
    const { data: salonRow, error: salonErr } = await supabase.from('salons').insert([{ owner: uid, email, name, slug }]).select().limit(1).single();
    if(salonErr){ authMsg.textContent = 'Profile create error: '+salonErr.message; return; }
    authMsg.textContent = 'Account created & profile saved. You are signed in.';
    emailInput.value=''; passwordInput.value=''; businessName.value=''; businessSlug.value='';
    currentSalon = salonRow;
    showDashboard();
    return;
  } else {
    // sign in
    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if(error){ authMsg.textContent = 'Sign in error: '+error.message; return; }
    // fetch salon profile for this user
    const uid = data?.user?.id;
    const { data: salons, error: salonErr } = await supabase.from('salons').select('*').eq('owner', uid).limit(1).maybeSingle();
    if(salonErr){ authMsg.textContent = 'Profile fetch error: '+salonErr.message; return; }
    if(!salons) { authMsg.textContent = 'No salon profile found for this account.'; return; }
    currentSalon = salons;
    showDashboard();
  }
});

/* show dashboard */
function showDashboard(){
  authCard.classList.add('hidden');
  dashboardCard.classList.remove('hidden');
  bizTitle.textContent = currentSalon.name;
  publicLink.href = window.location.origin + window.location.pathname + '?biz=' + currentSalon.slug;
  publicLink.textContent = 'Public â†’ ' + currentSalon.slug;
  examplePublic.textContent = window.location.origin + window.location.pathname + '?biz=your-slug';
  refreshData();
}

/* logout */
document.getElementById('logoutBtn').addEventListener('click', async ()=>{
  await supabase.auth.signOut();
  currentSalon = null;
  dashboardCard.classList.add('hidden');
  authCard.classList.remove('hidden');
});

/* refresh stats and table */
async function refreshData(){
  if(!currentSalon) return;
  // fetch appointments
  const { data: appts, error } = await supabase.from('appointments').select('*').eq('salon_id', currentSalon.id);
  if(error){ console.error('fetch appts err', error); return; }
  // compute stats
  const clients = [...new Set(appts.map(a=>a.client_name))].length;
  const upcoming = appts.filter(a=> new Date(a.appointment_time) > new Date()).length;
  const revenue = appts.reduce((s,a)=> s + parseFloat(a.price || 0), 0);
  statClients.textContent = clients;
  statUpcoming.textContent = upcoming;
  statRevenue.textContent = '$' + revenue.toFixed(2);

  // render table
  appts.sort((x,y)=> new Date(x.appointment_time) - new Date(y.appointment_time));
  apptsTbody.innerHTML = appts.map(a => {
    const when = new Date(a.appointment_time).toLocaleString();
    const status = a.notified ? 'Notified' : (a.pre_notified ? 'Reminder pending' : '');
    return `<tr class="border-b">
      <td class="py-2">${escapeHtml(a.client_name)}<div class="text-xs text-[--muted]">${escapeHtml(a.client_email || '')}</div></td>
      <td class="py-2">${escapeHtml(a.service)}</td>
      <td class="py-2">${when}</td>
      <td class="py-2">$${(a.price||0).toFixed(2)}</td>
      <td class="py-2">${status}</td>
      <td class="py-2">
        <button data-id="${a.id}" class="delBtn px-2 py-1 rounded bg-red-600">Delete</button>
      </td>
    </tr>`;
  }).join('');
  // hook delete buttons
  document.querySelectorAll('.delBtn').forEach(btn=>{
    btn.addEventListener('click', async (e)=>{
      const id = e.currentTarget.dataset.id;
      if(!confirm('Delete appointment?')) return;
      await supabase.from('appointments').delete().eq('id', id);
      refreshData();
    });
  });

  // subscription status
  const { data: subs } = await supabase.from('subscriptions').select('*').eq('salon_id', currentSalon.id).order('started_at', {ascending:false}).limit(1).maybeSingle();
  if(subs && subs.status === 'active' && new Date(subs.expires_at) > new Date()){
    subStatus.textContent = 'Subscribed until ' + new Date(subs.expires_at).toLocaleDateString();
  } else {
    subStatus.textContent = 'Not subscribed';
  }
}

/* add appointment via dashboard */
addApptForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  if(!currentSalon){ alert('Not signed in'); return; }
  const client_name = apClient.value.trim();
  const client_email = apEmail.value.trim();
  const service = apService.value.trim();
  const appointment_time = apDatetime.value;
  const price = parseFloat(apPrice.value) || 0;
  if(!client_name || !service || !appointment_time) return alert('Fill fields');

  const { data, error } = await supabase.from('appointments').insert([{ salon_id: currentSalon.id, client_name, client_email, service, appointment_time, price }]);
  if(error){ alert('Save error: '+error.message); return; }
  apClient.value=''; apEmail.value=''; apService.value=''; apDatetime.value=''; apPrice.value='';
  refreshData();
});

/* PUBLIC booking via ?biz=slug */
function initPublic(){
  const params = new URLSearchParams(window.location.search);
  const slug = params.get('biz');
  if(!slug){ publicFormWrap.classList.add('hidden'); noPublic.classList.remove('hidden'); return; }
  // find salon by slug (public select allowed)
  publicFormWrap.classList.remove('hidden'); noPublic.classList.add('hidden');
  // set title
  publicForm.querySelectorAll('input,button').forEach(i=> i.disabled = false);
  publicForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const client_name = document.getElementById('pubName').value.trim();
    const client_email = document.getElementById('pubEmail').value.trim();
    const service = document.getElementById('pubService').value.trim();
    const appointment_time = document.getElementById('pubDatetime').value;
    if(!client_name || !client_email || !service || !appointment_time) { publicMsg.textContent = 'Please fill all fields'; return; }
    // locate salon row by slug
    const { data: salon } = await supabase.from('salons').select('*').eq('slug', slug).maybeSingle();
    if(!salon){ publicMsg.textContent = 'Business not found'; return; }
    const { error } = await supabase.from('appointments').insert([{ salon_id: salon.id, client_name, client_email, service, appointment_time }]);
    if(error){ publicMsg.textContent = 'Save error: '+error.message; return; }
    publicMsg.textContent = 'Appointment requested â€” the business will see it in dashboard.';
    publicForm.reset();
  });
}

/* simulate payment: Insert subscription with expires_at = now + 30 days, status active */
subBtn.addEventListener('click', async ()=>{
  if(!currentSalon) return alert('Login first');
  const now = new Date();
  const expires = new Date(now.getTime() + 30*24*60*60*1000); // 30 days
  const { data, error } = await supabase.from('subscriptions').insert([{ salon_id: currentSalon.id, plan:'basic', status:'active', started_at: now.toISOString(), expires_at: expires.toISOString() }]);
  if(error){ alert('Subscription error: '+error.message); return; }
  alert('Simulated payment complete. Subscribed until ' + expires.toLocaleDateString());
  refreshData();
});

/* local notifications: check upcoming appointments for the signed-in owner and notify (pre-notify 15 min) */
setInterval(async ()=>{
  if(!currentSalon) return;
  // fetch upcoming not-yet-notified appts due within 15 minutes or past due and not notified
  const now = new Date().toISOString();
  const in15 = new Date(Date.now() + 15*60*1000).toISOString();
  const { data: appts } = await supabase.from('appointments')
    .select('*')
    .eq('salon_id', currentSalon.id)
    .or(`and(pre_notified.eq.false,appointment_time.lte.${in15}),and(notified.eq.false,appointment_time.lte.${now})`);
  if(!appts || appts.length===0) return;
  for(const a of appts){
    const when = new Date(a.appointment_time);
    const delta = when - new Date();
    if(!a.pre_notified && delta > 0 && delta <= 15*60*1000){
      // pre notify
      notifyLocal(currentSalon.name, `${a.client_name} in 15 min â€” ${a.service} at ${when.toLocaleString()}`);
      // set pre_notified true
      await supabase.from('appointments').update({ pre_notified:true }).eq('id', a.id);
    } else if(!a.notified && delta <= 0){
      notifyLocal(currentSalon.name, `${a.client_name} appointment now â€” ${a.service}`);
      await supabase.from('appointments').update({ notified:true }).eq('id', a.id);
    }
  }
  refreshData();
}, 30000);

/* simple notification helper */
function notifyLocal(title, text){
  if('Notification' in window && Notification.permission === 'granted'){
    try { new Notification(title, { body: text }); } catch(e){ console.log(e); }
  } else {
    Notification.requestPermission();
  }
}

/* helper: escape html */
function escapeHtml(s=''){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

/* init public booking if ?biz provided */
initPublic();

/* on load, if user already logged in, fetch profile */
(async function checkSession(){
  const { data } = await supabase.auth.getSession();
  const user = data?.session?.user;
  if(user){
    const { data: salon } = await supabase.from('salons').select('*').eq('owner', user.id).maybeSingle();
    if(salon){ currentSalon = salon; showDashboard(); }
  }
})();
</script>

</body>
</html>
