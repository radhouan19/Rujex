<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Booking Platform</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*{box-sizing:border-box;font-family:"Poppins",sans-serif;}
body{margin:0;padding:0;background:#f9fafb;}
section{display:none;min-height:100vh;padding:2rem;}
.active{display:block;}
header{background:#2563eb;color:white;text-align:center;padding:1.5rem;font-size:1.5rem;}
.btn{background:#2563eb;color:white;padding:.8rem 1.5rem;border:none;border-radius:8px;cursor:pointer;transition:.3s;margin:.2rem;}
.btn:hover{background:#1e40af;}
input,textarea,select{width:100%;padding:.8rem;margin:.5rem 0;border:1px solid #ccc;border-radius:8px;}
.container{max-width:600px;margin:auto;background:white;padding:2rem;border-radius:12px;box-shadow:0 5px 15px rgba(0,0,0,0.1);}
table{width:100%;border-collapse:collapse;margin-top:1rem;}
th,td{border:1px solid #ddd;padding:.8rem;text-align:left;}
th{background:#2563eb;color:white;}
tr:nth-child(even){background:#f3f4f6;}
.link-box{display:flex;align-items:center;justify-content:space-between;background:#eef2ff;padding:.8rem 1rem;border-radius:8px;margin-top:1rem;border:1px solid #c7d2fe;}
.link-box input{width:80%;border:none;background:transparent;font-size:.95rem;color:#1e3a8a;}
.top-right{position:absolute;top:1rem;right:1rem;}
</style>
</head>
<body>
<header>Booking Platform</header>

<!-- Landing -->
<section id="landing" class="active">
  <div class="container" style="text-align:center;">
    <h1>Welcome to Booking Platform</h1>
    <button class="btn" onclick="showSection('newOwner')">New Owner? Sign Up</button>
    <button class="btn" onclick="showSection('existingOwner')">Login</button>
  </div>
</section>

<!-- New Owner -->
<section id="newOwner">
  <div class="container">
    <h2>Sign Up</h2>
    <input id="newEmail" placeholder="Email" type="email">
    <input id="newPassword" placeholder="Password" type="password">
    <input id="newBusinessName" placeholder="Business Name">
    <button class="btn" onclick="registerNewOwner()">Register & Dashboard</button>
    <button class="btn" onclick="showSection('landing')">Back</button>
  </div>
</section>

<!-- Existing Owner -->
<section id="existingOwner">
  <div class="container">
    <h2>Login</h2>
    <input id="loginEmail" placeholder="Email" type="email">
    <input id="loginPassword" placeholder="Password" type="password">
    <button class="btn" onclick="loginExistingOwner()">Login</button>
    <button class="btn" onclick="showSection('landing')">Back</button>
  </div>
</section>

<!-- Owner Dashboard -->
<section id="dashboard">
  <button class="btn top-right" onclick="logout()">Logout</button>
  <div class="container">
    <h2>Owner Dashboard</h2>
    <p>Share this booking link:</p>
    <div class="link-box">
      <input id="shareLink" readonly>
      <button class="btn" onclick="copyLink()">Copy</button>
    </div>

    <h3>Services</h3>
    <table id="servicesTable">
      <thead><tr><th>Service</th><th>Price</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>
    <button class="btn" onclick="addService()">Add Service</button>

    <h3>Customer Bookings</h3>
    <table id="bookingsTable">
      <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Service</th><th>Date</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</section>

<!-- Customer Booking Page -->
<section id="customerPage">
  <div class="container">
    <h2>Book a Service</h2>
    <input id="cName" placeholder="Your Name">
    <input id="cEmail" placeholder="Your Email">
    <input id="cPhone" placeholder="Phone">
    <select id="cService"></select>
    <input id="cDate" type="datetime-local">
    <button class="btn" onclick="submitCustomerBooking()">Book Now</button>
  </div>
</section>

<script>
const SUPABASE_URL = "https://xwkpqhuxzaphvyjycetq.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh3a3BxaHV4emFwaHZ5anljZXRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwOTQ3ODEsImV4cCI6MjA3NTY3MDc4MX0.W0UueA_J9lWk9N5KIiYqcnPdXkTf-hlooVj2AqRkLFw";
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let servicesList = [];

function showSection(id){
  document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

async function registerNewOwner(){
  const email=document.getElementById("newEmail").value.trim();
  const password=document.getElementById("newPassword").value.trim();
  const business=document.getElementById("newBusinessName").value.trim();
  if(!email||!password||!business) return alert("Fill all fields");

  const { data:user,error } = await supabase.from("users").insert([{email,password}]).select().single();
  if(error) return alert("Error: "+error.message);

  const slug=business.toLowerCase().replace(/\s+/g,"-");
  await supabase.from("businesses").insert([{owner_id:user.id,business_name:business,business_slug:slug}]);

  localStorage.setItem("owner_id",user.id);
  setupDashboard(user.id,business,slug);
  showSection("dashboard");
}

async function loginExistingOwner(){
  const email=document.getElementById("loginEmail").value.trim();
  const password=document.getElementById("loginPassword").value.trim();
  const { data:user,error } = await supabase.from("users").select("*").eq("email",email).eq("password",password).single();
  if(error||!user) return alert("Invalid login");

  const { data:business } = await supabase.from("businesses").select("*").eq("owner_id",user.id).single();
  localStorage.setItem("owner_id",user.id);
  setupDashboard(user.id,business.business_name,business.business_slug);
  showSection("dashboard");
}

function logout(){
  localStorage.removeItem("owner_id");
  showSection("landing");
}

function setupDashboard(owner_id,businessName,slug){
  document.getElementById("shareLink").value=window.location.origin+"/?store="+slug;
  loadServices(owner_id);
  loadBookings(owner_id);
}

async function loadServices(owner_id){
  const { data, error } = await supabase.from("services").select("*").eq("owner_id",owner_id);
  servicesList = data || [];
  renderServices();
}

function renderServices(){
  const tbody = document.querySelector("#servicesTable tbody");
  tbody.innerHTML="";
  servicesList.forEach((s,i)=>{
    tbody.innerHTML+=`<tr>
      <td>${s.service_name}</td><td>${s.price}</td>
      <td>
        <button class="btn" onclick="editService(${i})">Edit</button>
        <button class="btn" onclick="deleteService(${i})">Delete</button>
      </td>
    </tr>`;
  });
}

async function addService(){
  const name=prompt("Service name");
  const price=prompt("Price");
  if(!name||isNaN(price)) return alert("Invalid");
  const owner_id=localStorage.getItem("owner_id");
  await supabase.from("services").insert([{owner_id,service_name:name,price:Number(price)}]);
  loadServices(owner_id);
}

async function editService(index){
  const s=servicesList[index];
  const name=prompt("Edit name",s.service_name);
  const price=prompt("Edit price",s.price);
  if(!name||isNaN(price)) return alert("Invalid");
  await supabase.from("services").update({service_name:name,price:Number(price)}).eq("id",s.id);
  loadServices(localStorage.getItem("owner_id"));
}

async function deleteService(index){
  const s=servicesList[index];
  await supabase.from("services").delete().eq("id",s.id);
  loadServices(localStorage.getItem("owner_id"));
}

async function loadBookings(owner_id){
  const { data } = await supabase.from("bookings").select("*").eq("owner_id",owner_id);
  const tbody = document.querySelector("#bookingsTable tbody");
  tbody.innerHTML="";
  (data||[]).forEach(b=>{
    tbody.innerHTML+=`<tr>
      <td>${b.name}</td><td>${b.email}</td><td>${b.phone}</td><td>${b.service_name}</td><td>${b.appointment_date}</td>
    </tr>`;
  });
}

// Customer Page
function loadCustomerPage(){
  const params = new URLSearchParams(window.location.search);
  const store = params.get("store");
  if(!store) return;
  showSection("customerPage");
  supabase.from("businesses").select("*").eq("business_slug",store).single().then(async ({data})=>{
    const owner_id = data.id;
    const { data:services } = await supabase.from("services").select("*").eq("owner_id",owner_id);
    const sel = document.getElementById("cService");
    sel.innerHTML="";
    services.forEach(s=>{
      const opt=document.createElement("option");
      opt.value=s.id;
      opt.textContent=`${s.service_name} ($${s.price})`;
      sel.appendChild(opt);
    });
    sel.dataset.owner=owner_id;
  });
}

async function submitCustomerBooking(){
  const name=document.getElementById("cName").value.trim();
  const email=document.getElementById("cEmail").value.trim();
  const phone=document.getElementById("cPhone").value.trim();
  const serviceId=document.getElementById("cService").value;
  const date=document.getElementById("cDate").value;
  const owner_id=document.getElementById("cService").dataset.owner;
  if(!name||!email||!phone||!serviceId||!date) return alert("Fill all");

  const { data:service } = await supabase.from("services").select("*").eq("id",serviceId).single();
  await supabase.from("bookings").insert([{owner_id,name,email,phone,service_name:service.service_name,appointment_date:date}]);
  alert("Booking submitted!");
  showSection("landing");
}

function copyLink(){
  const link = document.getElementById("shareLink");
  link.select();
  document.execCommand("copy");
  alert("Link copied!");
}

// Load customer page if URL has store param
if(window.location.search.includes("store=")){
  loadCustomerPage();
}
</script>
</body>
</html>
