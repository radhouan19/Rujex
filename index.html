<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>نونو — Booking Platform</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
.modal-backdrop { background: rgba(0,0,0,0.45); }
</style>
</head>
<body class="bg-gray-50 text-gray-800">

<div id="app" class="min-h-screen flex items-center justify-center p-6"
style="background-image: linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.6)), url('https://images.unsplash.com/photo-1504384308090-c894fdcc538d?auto=format&fit=crop&w=1600&q=80'); background-size:cover;">
  <div id="homeCard" class="bg-white/90 backdrop-blur-md rounded-2xl shadow-2xl p-8 text-center max-w-xl w-full">
    <h1 class="text-3xl font-bold mb-6">Grow Your Business with Online Bookings</h1>
    <div class="flex flex-col gap-4">
      <button onclick="startTrialPrompt()" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 rounded-xl shadow-lg transition">7-Day Free Trial</button>
      <button onclick="renderSignup()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 rounded-xl shadow-lg transition">Subscribe (11$/month)</button>
      <button onclick="renderLogin()" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-3 rounded-xl shadow-lg transition">Login</button>
    </div>
  </div>
</div>

<div id="modalContainer"></div>

<script>
/* ---------- Helpers ---------- */
function slugify(s){ return String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }
function qs(s){ return document.querySelector(s); }
function qsa(s){ return Array.from(document.querySelectorAll(s)); }
function uid(p='id'){ return p+'_'+Math.random().toString(36).slice(2,10); }
function downloadCSV(name, data){
  const blob = new Blob([data],{type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = name;
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* ---------- Storage ---------- */
function getUsers(){ return JSON.parse(localStorage.getItem('nono_users')||'[]'); }
function setUsers(arr){ localStorage.setItem('nono_users', JSON.stringify(arr)); }
function getServices(slug){ return JSON.parse(localStorage.getItem('nono_services_'+slug)||'[]'); }
function setServices(slug, arr){ localStorage.setItem('nono_services_'+slug, JSON.stringify(arr)); }
function getBookings(slug){ return JSON.parse(localStorage.getItem('nono_bookings_'+slug)||'[]'); }
function setBookings(slug, arr){ localStorage.setItem('nono_bookings_'+slug, JSON.stringify(arr)); }

/* ---------- User Handling ---------- */
function findUser(email){ return getUsers().find(u=>u.email===email); }
function saveUser(u){
  const arr=getUsers().filter(x=>x.email!==u.email); arr.push(u); setUsers(arr);
}

/* ---------- Trial ---------- */
function startTrialPrompt(){
  const name = prompt("Business name for 7-day trial");
  if(!name) return;
  const email = prompt("Email for trial login");
  if(!email) return;
  const password = prompt("Password for trial login");
  if(!password) return;
  const slug = slugify(name);
  const start = Date.now();
  const user = {email,password,name,slug,type:'trial',start};
  saveUser(user);
  alert("Trial created! You can login now.");
  renderDashboard(user);
}

/* ---------- Signup ---------- */
function renderSignup(){
  const container=document.getElementById('app');
  container.innerHTML = `
    <div class="min-h-screen flex items-center justify-center w-full">
      <div class="bg-white rounded-2xl shadow p-6 w-full max-w-md">
        <h2 class="text-2xl font-bold mb-4">Subscribe (11$/month)</h2>
        <input id="signup_name" placeholder="Business Name" class="w-full border rounded p-3 mb-3" />
        <input id="signup_email" placeholder="Email" class="w-full border rounded p-3 mb-3" />
        <input id="signup_password" placeholder="Password" type="password" class="w-full border rounded p-3 mb-3" />
        <button onclick="submitSignup()" class="w-full bg-blue-600 text-white py-3 rounded">Subscribe</button>
        <button onclick="renderHome()" class="w-full mt-2 border py-3 rounded">Cancel</button>
      </div>
    </div>`;
}

function submitSignup(){
  const name = qs('#signup_name').value.trim();
  const email = qs('#signup_email').value.trim();
  const password = qs('#signup_password').value.trim();
  if(!name||!email||!password) return alert("Fill all fields");
  const slug = slugify(name);
  const start = Date.now();
  const user = {email,password,name,slug,type:'subscribed',start};
  saveUser(user); setServices(slug,[]); setBookings(slug,[]);
  alert("Subscribed! Access your dashboard now."); renderDashboard(user);
}

/* ---------- Login ---------- */
function renderLogin(){
  const container=document.getElementById('app');
  container.innerHTML = `
    <div class="min-h-screen flex items-center justify-center w-full">
      <div class="bg-white rounded-2xl shadow p-6 w-full max-w-md">
        <h2 class="text-2xl font-bold mb-4">Login</h2>
        <input id="login_email" placeholder="Email" class="w-full border rounded p-3 mb-3" />
        <input id="login_password" placeholder="Password" type="password" class="w-full border rounded p-3 mb-3" />
        <button onclick="submitLogin()" class="w-full bg-purple-600 text-white py-3 rounded">Login</button>
        <button onclick="renderHome()" class="w-full mt-2 border py-3 rounded">Cancel</button>
      </div>
    </div>`;
}

function submitLogin(){
  const email=qs('#login_email').value.trim();
  const password=qs('#login_password').value.trim();
  const user=findUser(email);
  if(!user) return alert("No account found");
  if(user.password!==password) return alert("Wrong password");
  // check expiry
  const now=Date.now();
  if(user.type==='trial' && now-user.start>7*24*60*60*1000){ return alert("Trial expired"); }
  if(user.type==='subscribed' && now-user.start>30*24*60*60*1000){ return alert("Subscription expired"); }
  renderDashboard(user);
}

/* ---------- Dashboard ---------- */
function renderDashboard(user){
  const slug=user.slug;
  const expiry=(user.type==='trial'?7*24*60*60*1000:30*24*60*60*1000);
  const remaining=Math.max(0, expiry-(Date.now()-user.start));
  const days=Math.floor(remaining/(1000*60*60*24));
  const hours=Math.floor((remaining%(1000*60*60*24))/(1000*60*60));
  const minutes=Math.floor((remaining%(1000*60*60))/(1000*60));
  document.getElementById('app').innerHTML=`
  <div class="w-full min-h-screen flex flex-col">
    <header class="flex justify-between items-center p-4 bg-blue-600 text-white">
      <div>
        <div class="text-xl font-bold">${user.name}</div>
        <div class="text-sm">${user.email}</div>
      </div>
      <div class="flex gap-2 items-center">
        <div>Time left: ${days}d ${hours}h ${minutes}m</div>
        <button onclick="logout()" class="bg-white text-blue-600 px-3 py-1 rounded">Logout</button>
      </div>
    </header>
    <main class="p-6 flex-1 max-w-6xl mx-auto">
      <div class="mb-4">Share your booking link: <input readonly class="border px-2 py-1 w-64" value="${location.origin+location.pathname}?business=${slug}"></div>
      <div class="flex gap-4">
        <div class="w-64 bg-white rounded-xl p-4 shadow">
          <h3 class="font-semibold mb-2">Services</h3>
          <div class="flex gap-2 mb-2">
            <input id="svc_name" placeholder="Service" class="border p-1 flex-1" />
            <input id="svc_price" type="number" placeholder="Price" class="border p-1 w-20" />
            <button onclick="addService()" class="bg-green-600 text-white px-2 rounded">Add</button>
          </div>
          <div id="svc_list" class="space-y-1"></div>
        </div>
        <div class="flex-1 bg-white rounded-xl p-4 shadow">
          <h3 class="font-semibold mb-2">Bookings</h3>
          <table class="min-w-full text-left border">
            <thead class="bg-gray-100"><tr><th>Name</th><th>Email</th><th>Phone</th><th>Service</th><th>Date</th><th>Action</th></tr></thead>
            <tbody id="booking_list"></tbody>
          </table>
        </div>
      </div>
    </main>
  </div>`;
  populateServices();
  populateBookings();
}

/* ---------- Services ---------- */
function addService(){
  const name=qs('#svc_name').value.trim();
  const price=Number(qs('#svc_price').value);
  if(!name) return alert("Enter service name");
  const user=JSON.parse(localStorage.getItem('nono_users')).find(u=>location.search.includes(u.slug));
  const slug=user.slug;
  const arr=getServices(slug);
  arr.push({id:uid('s'),name,price});
  setServices(slug,arr);
  qs('#svc_name').value=''; qs('#svc_price').value='';
  populateServices();
}
function populateServices(){
  const user=JSON.parse(localStorage.getItem('nono_users')).find(u=>location.search.includes(u.slug));
  const slug=user.slug; const cont=qs('#svc_list');
  const arr=getServices(slug);
  cont.innerHTML=arr.map(s=>`<div class="flex justify-between items-center"><div>${s.name} ($${s.price})</div>
    <div class="flex gap-1"><button onclick="editService('${slug}','${s.id}')" class="text-yellow-500">Edit</button>
    <button onclick="deleteService('${slug}','${s.id}')" class="text-red-500">Del</button></div></div>`).join('');
}
function editService(slug,id){
  const arr=getServices(slug); const s=arr.find(x=>x.id===id); if(!s) return;
  const n=prompt("Service name",s.name); if(!n) return; const p=prompt("Price",$?s.price:0); s.name=n; s.price=Number(p)||0; setServices(slug,arr); populateServices();
}
function deleteService(slug,id){ const arr=getServices(slug).filter(x=>x.id!==id); setServices(slug,arr); populateServices(); }

/* ---------- Bookings ---------- */
function populateBookings(){
  const user=JSON.parse(localStorage.getItem('nono_users')).find(u=>location.search.includes(u.slug));
  const slug=user.slug; const arr=getBookings(slug);
  const cont=qs('#booking_list');
  cont.innerHTML=arr.length===0?'<tr><td colspan="6">No bookings</td></tr>':arr.map((b,i)=>`<tr class="border-t"><td>${b.name}</td><td>${b.email}</td><td>${b.phone}</td><td>${b.service}</td><td>${b.date}</td><td><button onclick="deleteBooking('${slug}',${i})" class="text-red-500">Del</button></td></tr>`).join('');
}
function deleteBooking(slug,index){ const arr=getBookings(slug); arr.splice(index,1); setBookings(slug,arr); populateBookings(); }

/* ---------- Logout ---------- */
function logout(){ location.href=location.pathname; }

/* ---------- Home ---------- */
function renderHome(){ location.href=location.pathname; }

</script>
/* ---------- Public Booking Page ---------- */
function renderPublicBooking(slug){
  const user=getUsers().find(u=>u.slug===slug);
  if(!user){ alert("Business not found"); return; }
  const services=getServices(slug);
  document.getElementById('app').innerHTML=`
    <div class="min-h-screen flex items-center justify-center p-6 bg-gray-100">
      <div class="bg-white rounded-2xl shadow-xl p-6 max-w-lg w-full">
        <h2 class="text-2xl font-bold mb-4 text-center">${user.name} — Book a Service</h2>
        <div class="mb-3">
          <input id="bk_name" placeholder="Your Name" class="w-full border rounded p-2 mb-2" />
          <input id="bk_email" placeholder="Your Email" class="w-full border rounded p-2 mb-2" />
          <input id="bk_phone" placeholder="Phone" class="w-full border rounded p-2 mb-2" />
          <select id="bk_service" class="w-full border rounded p-2 mb-2">
            ${services.map(s=>`<option value="${s.name}">${s.name} ($${s.price})</option>`).join('')}
          </select>
          <input type="date" id="bk_date" class="w-full border rounded p-2 mb-2"/>
          <button onclick="submitBooking('${slug}')" class="w-full bg-green-600 text-white py-2 rounded">Book</button>
        </div>
      </div>
    </div>`;
}

function submitBooking(slug){
  const name=qs('#bk_name').value.trim();
  const email=qs('#bk_email').value.trim();
  const phone=qs('#bk_phone').value.trim();
  const service=qs('#bk_service').value;
  const date=qs('#bk_date').value;
  if(!name||!email||!phone||!service||!date) return alert("Fill all fields");
  const arr=getBookings(slug); arr.push({name,email,phone,service,date}); setBookings(slug,arr);
  alert("Booking successful!");
  renderPublicBooking(slug);
}

/* ---------- Auto-Check URL for public booking ---------- */
window.addEventListener('load', ()=>{
  const params=new URLSearchParams(location.search);
  const business=params.get('business');
  if(business) renderPublicBooking(business);
});
</script>
</body>
</html>
