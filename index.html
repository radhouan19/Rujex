<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Salon Booking Platform</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*{box-sizing:border-box;font-family:"Poppins",sans-serif;}
body{margin:0;padding:0;background:#f9fafb;}
section{display:none;min-height:100vh;padding:2rem;}
.active{display:block;}
header{background:#2563eb;color:white;text-align:center;padding:1.5rem;font-size:1.5rem;}
.btn{background:#2563eb;color:white;padding:.8rem 1.5rem;border:none;border-radius:8px;cursor:pointer;transition:.3s;margin:.2rem;}
.btn:hover{background:#1e40af;}
input,textarea,select{width:100%;padding:.8rem;margin:.5rem 0;border:1px solid #ccc;border-radius:8px;}
.container{max-width:600px;margin:auto;background:white;padding:2rem;border-radius:12px;box-shadow:0 5px 15px rgba(0,0,0,0.1);}
table{width:100%;border-collapse:collapse;margin-top:1rem;}
th,td{border:1px solid #ddd;padding:.8rem;text-align:left;}
th{background:#2563eb;color:white;}
tr:nth-child(even){background:#f3f4f6;}
.link-box{display:flex;align-items:center;justify-content:space-between;background:#eef2ff;padding:.8rem 1rem;border-radius:8px;margin-top:1rem;border:1px solid #c7d2fe;}
.link-box input{width:80%;border:none;background:transparent;font-size:.95rem;color:#1e3a8a;}
.top-right{position:absolute;top:1rem;right:1rem;}
.paypal-like{display:inline-flex;align-items:center;gap:.6rem;background:#ffc439;color:#111;padding:.6rem 1rem;border-radius:8px;border:1px solid #f0c14b;font-weight:600;cursor:pointer;box-shadow: 0 2px 6px rgba(0,0,0,0.08);}
</style>
</head>
<body>
<header>Salon Booking Platform</header>

<!-- Landing / Choose Option -->
<section id="landing" class="active">
  <div class="container" style="text-align:center;">
    <h1>Grow Your Business</h1>
    <p>Select an option below:</p>
    <button class="btn" onclick="showSection('newOwner')">New Owner? Sign Up & Pay</button>
    <button class="btn" onclick="showSection('existingOwner')">Already Registered? Login</button>
  </div>
</section>

<!-- New Owner Sign Up -->
<section id="newOwner">
  <div class="container">
    <h2>Sign Up & Pay</h2>
    <input id="newEmail" placeholder="Email" type="email">
    <input id="newPassword" placeholder="Password" type="password">
    <input id="newBusinessName" placeholder="Business Name">
    <button class="btn paypal-like" onclick="registerNewOwner()">Pay & Go to Dashboard</button>
    <button class="btn" onclick="showSection('landing')">Back</button>
  </div>
</section>

<!-- Existing Owner Login -->
<section id="existingOwner">
  <div class="container">
    <h2>Login</h2>
    <input id="loginEmail" placeholder="Email" type="email">
    <input id="loginPassword" placeholder="Password" type="password">
    <button class="btn" onclick="loginExistingOwner()">Login</button>
    <button class="btn" onclick="showSection('landing')">Back</button>
  </div>
</section>

<!-- Dashboard / Owner -->
<section id="dashboard">
  <button class="btn top-right" onclick="logout()">Logout</button>
  <div class="container">
    <h2>Owner Dashboard</h2>
    <p>Share your booking link ðŸ‘‡</p>
    <div class="link-box">
      <input id="shareLink" readonly>
      <button class="btn" onclick="copyLink()">Copy</button>
    </div>

    <h3 style="margin-top:2rem;">Your Services</h3>
    <table id="servicesTable">
      <thead><tr><th>Service</th><th>Price ($)</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>
    <button class="btn" onclick="showAddService()">Add New Service</button>

    <h3 style="margin-top:2rem;">Customer Appointments</h3>
    <table id="bookingsTable">
      <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Date</th><th>Service</th><th>Price ($)</th><th>Note</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</section>

<!-- Booking (Customer) -->
<section id="booking">
  <div class="container">
    <h2>Book a Service</h2>
    <div id="businessName" style="margin-bottom:1rem;font-weight:bold;"></div>
    <select id="serviceSelect"></select>
    <input id="custName" placeholder="Your Name">
    <input id="custEmail" placeholder="Your Email" type="email">
    <input id="custPhone" placeholder="Phone Number">
    <input id="custDate" type="datetime-local">
    <textarea id="custNote" placeholder="Additional notes"></textarea>
    <button class="btn" onclick="submitBooking()">Submit</button>
    <div id="status" style="margin-top:1rem;color:green;"></div>
  </div>
</section>

<script>
const SUPABASE_URL = "https://xwkpqhuxzaphvyjycetq.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh3a3BxaHV4emFwaHZ5anljZXRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwOTQ3ODEsImV4cCI6MjA3NTY3MDc4MX0.W0UueA_J9lWk9N5KIiYqcnPdXkTf-hlooVj2AqRkLFw";

const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
let currentServices = [];
let bookingsList = [];
let business = null;

// ---------------- Navigation ----------------
function showSection(id){
  document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

// ---------- Owner Registration ----------
async function registerNewOwner(){
  const email = document.getElementById("newEmail").value.trim();
  const password = document.getElementById("newPassword").value.trim();
  const businessName = document.getElementById("newBusinessName").value.trim();
  if(!email||!password||!businessName) return alert("Fill all fields");

  let userId;
  try {
    const { data: user, error } = await supabase.from("users").insert([{email,password}]).select().single();
    if(error) throw error;
    const slug = businessName.toLowerCase().replace(/\s+/g,"-");
    const { error: be } = await supabase.from("businesses").insert([{owner_id:user.id,business_name:businessName,business_slug:slug}]);
    if(be) throw be;
    userId = user.id;
  } catch(e){
    console.error(e);
    alert("Error creating account");
    return;
  }
  localStorage.setItem("user_id", userId);
  showSection("dashboard");
  setupDashboard(userId,businessName);
}

// ---------- Owner Login ----------
async function loginExistingOwner(){
  const email = document.getElementById("loginEmail").value.trim();
  const password = document.getElementById("loginPassword").value.trim();
  if(!email||!password) return alert("Fill all fields");

  try{
    const { data: user, error } = await supabase.from("users").select("*").eq("email",email).eq("password",password).single();
    if(error||!user) return alert("Invalid credentials");
    localStorage.setItem("user_id", user.id);
    const { data: business } = await supabase.from("businesses").select("*").eq("owner_id",user.id).single();
    setupDashboard(user.id, business.business_name);
  } catch(e){
    console.error(e);
    alert("Login error");
  }
}

// ---------- Dashboard Setup ----------
async function setupDashboard(userId,businessName){
  // Share link
  const slug = businessName.toLowerCase().replace(/\s+/g,"-");
  document.getElementById("shareLink").value = window.location.origin + window.location.pathname + "?store=" + slug;

  // Load services
  const { data: srv } = await supabase.from("services").select("*").eq("owner_id",userId);
  currentServices = srv || [];
  renderServices();

  // Load bookings
  loadBookings(userId);
}

function showAddService(){
  const name = prompt("Enter service name:");
  if(!name) return;
  const price = prompt("Enter price ($):");
  if(!price||isNaN(price)) return alert("Invalid price");
  const userId = localStorage.getItem("user_id");
  supabase.from("services").insert([{owner_id:userId, service_name:name, price:Number(price)}]).then(()=>loadBookings(userId).then(renderServices()));
}

function renderServices(){
  const tbody=document.querySelector("#servicesTable tbody");
  tbody.innerHTML="";
  currentServices.forEach(s=>{
    tbody.innerHTML+=`<tr><td>${s.service_name}</td><td>${s.price}</td><td></td></tr>`;
  });

  const sel = document.getElementById("serviceSelect");
  sel.innerHTML="";
  currentServices.forEach(s=>{
    const opt = document.createElement("option");
    opt.value = s.id;
    opt.textContent = `${s.service_name} ($${s.price})`;
    sel.appendChild(opt);
  });
}

async function loadBookings(userId){
  const { data: bks } = await supabase.from("bookings").select("*").eq("business_id",userId);
  bookingsList = bks || [];
  const tbody=document.querySelector("#bookingsTable tbody");
  tbody.innerHTML="";
  bookingsList.forEach(b=>{
    const s = currentServices.find(s=>s.id===b.service_id);
    tbody.innerHTML+=`<tr>
      <td>${b.name}</td><td>${b.email}</td><td>${b.phone}</td>
      <td>${b.appointment_date}</td><td>${s?s.service_name:""}</td><td>${s?s.price:""}</td><td>${b.note}</td>
    </tr>`;
  });
}

// ---------- Customer Booking ----------
const params = new URLSearchParams(window.location.search);
const slug = params.get('store');
async function loadBusinessCustomer(){
  if(!slug) return;
  const { data: b } = await supabase.from("businesses").select("*").eq("business_slug",slug).single();
  if(!b) return;
  business = b;
  document.getElementById("businessName").innerText = "Booking for: " + b.business_name;
  const { data: srv } = await supabase.from("services").select("*").eq("owner_id",b.owner_id);
  currentServices = srv || [];
  renderServices();
  showSection("booking");
}

async function submitBooking(){
  const service_id = document.getElementById("serviceSelect").value;
  const name = document.getElementById("custName").value.trim();
  const email = document.getElementById("custEmail").value.trim();
  const phone = document.getElementById("custPhone").
    .value.trim();
  const date = document.getElementById("custDate").value;
  const note = document.getElementById("custNote").value.trim();
  if(!service_id || !name || !email || !phone || !date) return alert("Fill all fields");

  try{
    await supabase.from("bookings").insert([{
      business_id: business.owner_id,
      service_id,
      name,
      email,
      phone,
      appointment_date: date,
      note
    }]);
    document.getElementById("status").innerText = "âœ… Booking submitted!";
    document.getElementById("custName").value = "";
    document.getElementById("custEmail").value = "";
    document.getElementById("custPhone").value = "";
    document.getElementById("custDate").value = "";
    document.getElementById("custNote").value = "";
  } catch(e){
    console.error(e);
    alert("Error submitting booking");
  }
}

// ---------- Logout ----------
function logout(){
  localStorage.removeItem("user_id");
  showSection("landing");
}

// ---------- Copy Link ----------
function copyLink(){
  const link = document.getElementById("shareLink");
  link.select();
  link.setSelectionRange(0,99999);
  document.execCommand("copy");
  alert("Link copied!");
}

// ---------- Init ----------
window.addEventListener("load", ()=>{
  const userId = localStorage.getItem("user_id");
  if(userId) setupDashboard(userId,"Your Business");
  loadBusinessCustomer();
});
</script>
</body>
</html>
    
